BootStrap: library
From: ubuntu:18.04


%files    
    scripts /usr/local    

%environment
    export LC_ALL=C
    export PATH=/usr/local:/usr/local/scripts:$PATH


%post
    apt-get update && apt-get install -y netcat
    NOW=`date`
    echo "export NOW=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

    apt-get install -y software-properties-common
    add-apt-repository universe

    apt-get install -y wget
    apt-get install -y unzip
    apt-get install -y rsync
    apt-get install -y tar     
    apt-get install -y python3
    apt-get install -y python3-pip
    pip3 install -i https://test.pypi.org/simple/ aircrushcore

    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        build-essential \
        libssl-dev \
        uuid-dev \
        libgpgme11-dev \
        squashfs-tools \
        libseccomp-dev \
        wget \
        pkg-config \
        git \
        cryptsetup

    export VERSION=1.16.4 OS=linux ARCH=amd64
    wget https://dl.google.com/go/go$VERSION.$OS-$ARCH.tar.gz
    tar -C /usr/local -xzvf go$VERSION.$OS-$ARCH.tar.gz
    rm go$VERSION.$OS-$ARCH.tar.gz
    
    export PATH=/usr/local/go/bin:$PATH

    #echo 'export PATH=/usr/local/go/bin:$PATH' >> ~/.bashrc && \
    #source ~/.bashrc

    export VERSION=3.8.1
    wget https://github.com/sylabs/singularity/releases/download/v${VERSION}/singularity-ce-${VERSION}.tar.gz
    tar -xzf singularity-ce-${VERSION}.tar.gz
    cd singularity-ce-${VERSION}

    ./mconfig
    make -C builddir
    make -C builddir install

    chmod ugo+x /usr/local/scripts/*
%runscript    
    echo "Arguments received: first: $1    all:$*"
    /bin/bash $*


%labels
    Author dmattie


###############
# pull_dataset
###############
%apphelp pull_dataset
       
Copy data from the data commons to local working directory."

Usage: pull_dataset [OPTIONS...]"
options:"
--help                                 Print this Help."
--datacommons DIR                      Path to data commons root"
--stage [source|rawdata|derivatives]   Stage to clone. All if omitted"
--workingdir  DIR                      Path to working directory"
--project PROJECT                      Project ID.  If subject and/or session not"
                                       specified, clone the entire project"
--subject SUBJECT                      Specify subject ID to clone.  If session not"
                                       specified, then clone the entire subject"
--session SESSION                      Specify session ID to clone"
--pipeline PIPELINE                    If stage is set to derivatives, pipeline ID must be specified"


    Example:
        singularity run --app pull_dataset air-neuro.sif --datacommons ~/projects/def-user/datacommons --workingdir ~/scratch/aircrush -project projectid --subject 1234
%apprun pull_dataset
    /usr/local/scripts/pull_dataset.sh $*

###############
# bids
###############
%apphelp bids
    Reformat given directory into BIDS compliant directory (best effort)
    Usage:
        singularity run --app bids air-neuro.sif source target

    Example:
        singularity run --app bids air-neuro.sif ~/scratch/dataset/source/123456 ~/scratch/dataset/rawdata
%apprun bids
    /usr/local/scripts/bids.sh $*

###############
# recon
###############
%apphelp recon
    Image reconstruction of T1 structural image using Freesurfer's recon-all 
    command.
    Usage:
        singularity run --app recon [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app recon air-neuro.sif rawdata/sub-12345/ses-001
%apprun recon
    /usr/local/scripts/recon.sh $*

###############
# registration
###############
%apphelp registration
    Registration of T1 structural image to Diffusion Weighted Image.    
    Usage:
        singularity run --app registration econ [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app registration air-neuro.sif rawdata/sub-12345/ses-001
%apprun registration
    /usr/local/scripts/registration.sh $*
    
###############
# parcellate
###############
%apphelp parcellate
    Parcellation of reconstructed T1 structural image individual ROI volumes    
    Usage:
        singularity run --app parcellate [air-neuro.sif] [path-to-subject/session] [plugin]
    Example: 
        singularity run --app parcellate air-neuro.sif rawdata/sub-12345/ses-001 levman
%apprun parcellate
    /usr/local/scripts/parcellate.sh $*

###############
# crush
###############
%apphelp crush
    CRUSH of fibre tracts across each individual ROI volume    
    Usage:
        singularity run --app crush [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app crush air-neuro.sif derivatives/levman/sub-12345/ses-001 levman
%apprun crush
    /usr/local/scripts/crush.sh $*
    