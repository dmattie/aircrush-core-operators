BootStrap: docker
From: ubuntu:18.04

%files
    #/home/dmattie/software /usr/local
    /home/dmattie/software/freesurfer_license.txt /usr/local/freesurfer/7.2.0/license.txt
    /home/dmattie/software/freesurfer_license.txt /usr/local/freesurfer/7.2.0/.license
    
    scripts /usr/local

%environment
    export LC_ALL=C
    export PATH=/usr/local:/usr/local/scripts:$PATH
    export LD_LIBRARY_PATH=/usr/lib/fsl/5.0:$LD_LIBRARY_PATH
    export DSI_PATH=/usr/local/software/matrices
    export FSLOUTPUTTYPE=NIFTI_GZ
    export FREESURFER_HOME=/usr/local/freesurfer/7.2.0
    export FSLDIR=/opt/fsl
    source $FREESURFER_HOME/SetUpFreeSurfer.sh
    export PATH=$PATH:/usr/local/software:/usr/local/software/MRIcroGL/Resources:$FSLDIR/bin
    export SUBJECTS_DIR=.
%post
    apt-get update && apt-get install -y netcat
    NOW=`date`
    echo "export NOW=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT
    apt-get install -y wget
    apt-get install -y unzip
    apt-get install -y rsync
    apt-get install -y tar
    apt-get install -y dialog

    apt-get install -y software-properties-common
    add-apt-repository universe

    apt-get install -y redis-server

#    DEBIAN_FRONTEND=noninteractive apt-get install -y xorg xorg-dev
#  
#    apt-get install -y language-pack-en binutils libx11-dev gettext x11-apps perl make file bc \
#    xserver-xorg-video-intel libdbus-1-3 libdrm2 libexpat1 libfontconfig1 libfreetype6 libgl1 \
#    libglib2.0-0 libglu1-mesa libglvnd0 libglx0 libgomp1 libgssapi-krb5-2 libice6 libjpeg-dev libk5crypto3 \
#    libkeyutils1 libkrb5-3 libkrb5support0 libkrb5support0 libpng16-16 libsm6 libx11-6 \
#    libx11-xcb1 libxau6 libxcb1 libxdmcp6 libxext6 libxft2 libxi6 libxmu6 libxrender1 libxss1 libxt6
#
#    apt-get install -y xterm csh tcsh libjpeg62 
#
#    dpkg -i /usr/local/software/freesurfer_7.2.0_amd64.deb; apt-get -fy install
#    apt install -y python-minimal
#    
#    python /usr/local/software/fslinstaller.py -d /opt/fsl

##    wget -O- http://neuro.debian.net/lists/bionic.us-nh.full | tee /etc/apt/sources.list.d/neurodebian.sources.list
##    apt-key adv --recv-keys --keyserver hkps://keyserver.ubuntu.com 0xA5D32F012649A5A9
##    apt-get update
##    apt-get install -y fsl-5.0-core
    
#    apt-get install -y python3
#    apt-get install -y python3-pip
#    pip3 install -i https://test.pypi.org/simple/ aircrushcore
 
#    chmod -R a+rx /usr/local/software/*
    chmod -R a+rx /usr/local/scripts
%runscript    
    echo "Arguments received: first: $1    all:$*"
    /bin/bash $*


%labels
    Author dmattie


###############
# pull_dataset
###############
%apphelp pull_dataset
       
Copy data from the data commons to local working directory."

Usage: pull_dataset [OPTIONS...]"
options:"
--help                                 Print this Help."
--datacommons DIR                      Path to data commons root"
--stage [source|rawdata|derivatives]   Stage to clone. All if omitted"
--workingdir  DIR                      Path to working directory"
--project PROJECT                      Project ID.  If subject and/or session not"
                                       specified, clone the entire project"
--subject SUBJECT                      Specify subject ID to clone.  If session not"
                                       specified, then clone the entire subject"
--session SESSION                      Specify session ID to clone"
--pipeline PIPELINE                    If stage is set to derivatives, pipeline ID must be specified"


    Example:
        singularity run --app pull_dataset air-neuro.sif --datacommons ~/projects/def-user/datacommons --workingdir ~/scratch/aircrush -project projectid --subject 1234
%apprun pull_dataset
    if [ -f ~/.airneuro.conf ];then
        SCRIPT_HOME=$(cat ~/.airneuro.conf|grep script_home_override|cut -d= -f2)
        echo "Script home overridden from .airneuro.conf setting:  $SCRIPT_HOME to be used"
    else
        SCRIPT_HOME=/usr/local/scripts
    fi
    $SCRIPT_HOME/pull_dataset.sh $*

###############
# bids
###############
%apphelp bids
    Reformat given directory into BIDS compliant directory (best effort)
    Usage:
        singularity run --app bids air-neuro.sif source target

    Example:
        singularity run --app bids air-neuro.sif ~/scratch/dataset/source/123456 ~/scratch/dataset/rawdata
%apprun bids
    if [ -f ~/.airneuro.conf ];then
        SCRIPT_HOME=$(cat ~/.airneuro.conf|grep script_home_override|cut -d= -f2)
        echo "Script home overridden from .airneuro.conf setting:  $SCRIPT_HOME to be used"
    else
        SCRIPT_HOME=/usr/local/scripts
    fi
    $SCRIPT_HOME/bids.sh $*

###############
# recon
###############
%apphelp recon
    Image reconstruction of T1 structural image using Freesurfer's recon-all 
    command.
    Usage:
        singularity run --app recon [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app recon air-neuro.sif rawdata/sub-12345/ses-001
%apprun recon
    if [ -f ~/.airneuro.conf ];then
        SCRIPT_HOME=$(cat ~/.airneuro.conf|grep script_home_override|cut -d= -f2)
        echo "Script home overridden from .airneuro.conf setting:  $SCRIPT_HOME to be used"
    else
        SCRIPT_HOME=/usr/local/scripts
    fi
    $SCRIPT_HOME/recon.sh $*

###############
# registration
###############
%apphelp registration
    Registration of T1 structural image to Diffusion Weighted Image.    
    Usage:
        singularity run --app registration econ [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app registration air-neuro.sif rawdata/sub-12345/ses-001
%apprun registration
    if [ -f ~/.airneuro.conf ];then
        SCRIPT_HOME=$(cat ~/.airneuro.conf|grep script_home_override|cut -d= -f2)
        echo "Script home overridden from .airneuro.conf setting:  $SCRIPT_HOME to be used"
    else
        SCRIPT_HOME=/usr/local/scripts
    fi
    $SCRIPT_HOME/registration.sh $*
    
###############
# parcellate
###############
%apphelp parcellate
    Parcellation of reconstructed T1 structural image individual ROI volumes    
    Usage:
        singularity run --app parcellate [air-neuro.sif] [path-to-subject/session] [plugin]
    Example: 
        singularity run --app parcellate air-neuro.sif rawdata/sub-12345/ses-001 levman
%apprun parcellate
    if [ -f ~/.airneuro.conf ];then
        SCRIPT_HOME=$(cat ~/.airneuro.conf|grep script_home_override|cut -d= -f2)
        echo "Script home overridden from .airneuro.conf setting:  $SCRIPT_HOME to be used"
    else
        SCRIPT_HOME=/usr/local/scripts
    fi
    $SCRIPT_HOME/parcellate.sh $*

###############
# crush
###############
%apphelp crush
    CRUSH of fibre tracts across each individual ROI volume    
    Usage:
        singularity run --app crush [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app crush air-neuro.sif derivatives/levman/sub-12345/ses-001 levman
%apprun crush
    if [ -f ~/.airneuro.conf ];then
        SCRIPT_HOME=$(cat ~/.airneuro.conf|grep script_home_override|cut -d= -f2)
        echo "Script home overridden from .airneuro.conf setting:  $SCRIPT_HOME to be used"
    else
        SCRIPT_HOME=/usr/local/scripts
    fi
    $SCRIPT_HOME/crush.sh $*
    