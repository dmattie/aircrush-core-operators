BootStrap: library
From: ubuntu:18.04

%post
    #Install required software
    apt-get update
    apt-get install -y wget
    apt-get install -y unzip
    apt-get install -y rsync
    apt-get install -y tar

    #Download Trackvis
    cd /usr/local/
    #wget -q https://www.nitrc.org/frs/download.php/12104/MRIcroGL_linux.zip
    #unzip MRIcroGL_linux.zip

    apt-get install -y python3.6
    update-alternatives --install /usr/bin/python python /usr/bin/python3.6 1
    update-alternatives  --set python /usr/bin/python3.6

    #git clone https://github.com/dmattie/aircrush-core-operators
    #mv aircrush-core-operators/operators operators
    #rm -r aircrush-core-operators

    chmod ugo+x /usr/local/aircrush/scripts/*
    
%files
    /tmp/air-neuro/scripts /usr/local/aircrush/scripts
    

%environment
    export LC_ALL=C
    export PATH=/usr/local:/usr/local/aircrush/scripts:$PATH

%runscript    
    echo "Arguments received: first: $1    all:$*"
    /bin/bash $*


%labels
    Author dmattie


###############
# pull_dataset
###############
%apphelp pull_dataset
       
Copy data from the data commons to local working directory."

Usage: pull_dataset [OPTIONS...]"
options:"
--help                                 Print this Help."
--datacommons DIR                      Path to data commons root"
--stage [source|rawdata|derivatives]   Stage to clone. All if omitted"
--workingdir  DIR                      Path to working directory"
--project PROJECT                      Project ID.  If subject and/or session not"
                                       specified, clone the entire project"
--subject SUBJECT                      Specify subject ID to clone.  If session not"
                                       specified, then clone the entire subject"
--session SESSION                      Specify session ID to clone"
--pipeline PIPELINE                    If stage is set to derivatives, pipeline ID must be specified"


    Example:
        singularity run --app pull_dataset air-neuro.sif --datacommons ~/projects/def-user/datacommons --workingdir ~/scratch/aircrush -project projectid --subject 1234
%apprun pull_dataset
    /usr/local/aircrush/scripts/pull_dataset.sh $*

###############
# bids
###############
%apphelp bids
    Reformat given directory into BIDS compliant directory (best effort)
    Usage:
        singularity run --app bids air-neuro.sif source target

    Example:
        singularity run --app bids air-neuro.sif ~/scratch/dataset/source/123456 ~/scratch/dataset/rawdata
%apprun bids
    /usr/local/aircrush/scripts/bids.sh $*

###############
# recon
###############
%apphelp recon
    Image reconstruction of T1 structural image using Freesurfer's recon-all 
    command.
    Usage:
        singularity run --app recon [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app recon air-neuro.sif rawdata/sub-12345/ses-001
%apprun recon
    /usr/local/aircrush/scripts/recon.sh $*

###############
# registration
###############
%apphelp registration
    Registration of T1 structural image to Diffusion Weighted Image.    
    Usage:
        singularity run --app registration econ [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app registration air-neuro.sif rawdata/sub-12345/ses-001
%apprun registration
    /usr/local/aircrush/scripts/registration.sh $*
    
###############
# parcellate
###############
%apphelp parcellate
    Parcellation of reconstructed T1 structural image individual ROI volumes    
    Usage:
        singularity run --app parcellate [air-neuro.sif] [path-to-subject/session] [plugin]
    Example: 
        singularity run --app parcellate air-neuro.sif rawdata/sub-12345/ses-001 levman
%apprun parcellate
    /usr/local/aircrush/scripts/parcellate.sh $*

###############
# crush
###############
%apphelp crush
    CRUSH of fibre tracts across each individual ROI volume    
    Usage:
        singularity run --app crush [air-neuro.sif] [path-to-subject/session]
    Example: 
        singularity run --app crush air-neuro.sif derivatives/levman/sub-12345/ses-001 levman
%apprun crush
    /usr/local/aircrush/scripts/crush.sh $*
    